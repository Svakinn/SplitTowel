define(["durandal/system","knockout"],function(e,t){function n(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=u.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=u.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=u.defaults.afterDeactivate),e.affirmations||(e.affirmations=u.defaults.affirmations),e.interpretResponse||(e.interpretResponse=u.defaults.interpretResponse),e.areSameItem||(e.areSameItem=u.defaults.areSameItem),e}function i(t,n,i){return e.isArray(i)?t[n].apply(t,i):t[n](i)}function r(t,n,i,r,o){if(t&&t.deactivate){e.log("Deactivating",t);var a;try{a=t.deactivate(n)}catch(c){return e.error(c),r.resolve(!1),void 0}a&&a.then?a.then(function(){i.afterDeactivate(t,n,o),r.resolve(!0)},function(t){e.log(t),r.resolve(!1)}):(i.afterDeactivate(t,n,o),r.resolve(!0))}else t&&i.afterDeactivate(t,n,o),r.resolve(!0)}function o(t,n,r,o){if(t)if(t.activate){e.log("Activating",t);var a;try{a=i(t,"activate",o)}catch(c){return e.error(c),r(!1),void 0}a&&a.then?a.then(function(){n(t),r(!0)},function(t){e.log(t),r(!1)}):(n(t),r(!0))}else n(t),r(!0);else r(!0)}function a(t,n,i){return i.lifecycleData=null,e.defer(function(r){if(t&&t.canDeactivate){var o;try{o=t.canDeactivate(n)}catch(a){return e.error(a),r.resolve(!1),void 0}o.then?o.then(function(e){i.lifecycleData=e,r.resolve(i.interpretResponse(e))},function(t){e.error(t),r.resolve(!1)}):(i.lifecycleData=o,r.resolve(i.interpretResponse(o)))}else r.resolve(!0)}).promise()}function c(t,n,r,o){return r.lifecycleData=null,e.defer(function(a){if(t==n())return a.resolve(!0),void 0;if(t&&t.canActivate){var c;try{c=i(t,"canActivate",o)}catch(s){return e.error(s),a.resolve(!1),void 0}c.then?c.then(function(e){r.lifecycleData=e,a.resolve(r.interpretResponse(e))},function(t){e.error(t),a.resolve(!1)}):(r.lifecycleData=c,a.resolve(r.interpretResponse(c)))}else a.resolve(!0)}).promise()}function s(i,s){var u,l=t.observable(null);s=n(s);var f=t.computed({read:function(){return l()},write:function(e){f.viaSetter=!0,f.activateItem(e)}});return f.__activator__=!0,f.settings=s,s.activator=f,f.isActivating=t.observable(!1),f.canDeactivateItem=function(e,t){return a(e,t,s)},f.deactivateItem=function(t,n){return e.defer(function(e){f.canDeactivateItem(t,n).then(function(i){i?r(t,n,s,e,l):(f.notifySubscribers(),e.resolve(!1))})}).promise()},f.canActivateItem=function(e,t){return c(e,l,s,t)},f.activateItem=function(t,n){var i=f.viaSetter;return f.viaSetter=!1,e.defer(function(a){if(f.isActivating())return a.resolve(!1),void 0;f.isActivating(!0);var c=l();return s.areSameItem(c,t,u,n)?(f.isActivating(!1),a.resolve(!0),void 0):(f.canDeactivateItem(c,s.closeOnDeactivate).then(function(v){v?f.canActivateItem(t,n).then(function(v){v?e.defer(function(e){r(c,s.closeOnDeactivate,s,e)}).promise().then(function(){t=s.beforeActivate(t,n),o(t,l,function(e){u=n,f.isActivating(!1),a.resolve(e)},n)}):(i&&f.notifySubscribers(),f.isActivating(!1),a.resolve(!1))}):(i&&f.notifySubscribers(),f.isActivating(!1),a.resolve(!1))}),void 0)}).promise()},f.canActivate=function(){var e;return i?(e=i,i=!1):e=f(),f.canActivateItem(e)},f.activate=function(){var e;return i?(e=i,i=!1):e=f(),f.activateItem(e)},f.canDeactivate=function(e){return f.canDeactivateItem(f(),e)},f.deactivate=function(e){return f.deactivateItem(f(),e)},f.includeIn=function(e){e.canActivate=function(){return f.canActivate()},e.activate=function(){return f.activate()},e.canDeactivate=function(e){return f.canDeactivate(e)},e.deactivate=function(e){return f.deactivate(e)}},s.includeIn?f.includeIn(s.includeIn):i&&f.activate(),f.forItems=function(t){s.closeOnDeactivate=!1,s.determineNextItemToActivate=function(e,t){var n=t-1;return-1==n&&e.length>1?e[1]:n>-1&&n<e.length-1?e[n]:null},s.beforeActivate=function(e){var n=f();if(e){var i=t.indexOf(e);-1==i?t.push(e):e=t()[i]}else e=s.determineNextItemToActivate(t,n?t.indexOf(n):0);return e},s.afterDeactivate=function(e,n){n&&t.remove(e)};var n=f.canDeactivate;f.canDeactivate=function(i){return i?e.defer(function(e){function n(){for(var t=0;t<o.length;t++)if(!o[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var r=t(),o=[],a=0;a<r.length;a++)f.canDeactivateItem(r[a],i).then(function(e){o.push(e),o.length==r.length&&n()})}).promise():n()};var i=f.deactivate;return f.deactivate=function(n){return n?e.defer(function(e){function i(i){f.deactivateItem(i,n).then(function(){o++,t.remove(i),o==a&&e.resolve()})}for(var r=t(),o=0,a=r.length,c=0;a>c;c++)i(r[c])}).promise():i()},f},f}var u,l={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(n){return e.isObject(n)&&(n=n.can||!1),e.isString(n)?-1!==t.utils.arrayIndexOf(this.affirmations,n.toLowerCase()):n},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,n){t&&n&&n(null)}};return u={defaults:l,create:s,isActivator:function(e){return e&&e.__activator__}}});